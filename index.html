<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<title></title>
<script src="js/mui.min.js"></script>
<script src="js/setting.js"></script>
<script src="js/app.js" type="text/javascript" charset="utf-8"></script>
<link href="css/mui.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="css/iconfont.css" />
<script type="text/javascript" charset="utf-8">
mui.init({
	swipeBack: false,
	statusBarBackground: '#f7f7f7',
	gestureConfig:{doubletap:true}
});
mui.plusReady(function() {
	document.addEventListener('netchange',app.checkNetwork,false);
	//读取本地存储，检查是否为首次启动
	if(!plus.storage.getItem("lauchFlag")){
		mui.openWindow({id:'guide',url:'guide.html',show:{aniShow:'none'},waiting:{autoShow:false}});
	}else{
		mui.later(function(){
			plus.navigator.closeSplashscreen();//关闭splash页面；
			plus.navigator.setFullscreen(false);//显示状态栏；
		},1500)
	}
	
	//检查更新
	app.checkUpdate();
	app.setUser();//刷新用户状态
    var self = plus.webview.currentWebview();
    var subpages = ['home','team','discovery','account'];
    for(var i=0;i<subpages.length;i++){
    	var sub = plus.webview.create(subpages[i]+'.html',subpages[i],{top: 44+immersed,bottom: 51});
    	self.append(sub);
    	if(subpages[i] == "home"){
    		sub.show();
    	}else{
    		sub.hide();
    	}
    }
    //双击头部返回顶部
    var contentWebview = null;
	document.querySelector('header').addEventListener('doubletap',function () {
		if(contentWebview==null){
			contentWebview = plus.webview.currentWebview().children()[0];
		}
		contentWebview.evalJS("mui('#refreshContainer').pullRefresh().scrollTo(0,0,300)");
	});
	//点击打开消息页
	var chatPage = mui.preload({id:'chat',url:"chat.html"});
	document.querySelector('.icon-bubble').addEventListener('tap',function(){
		chatPage.show();
		document.querySelector('.mui-pull-right span').style.display = 'none';
	})
	//选择城市
    document.getElementById("citySelect").addEventListener('tap',function(){
    	plus.webview.getWebviewById("home").evalJS("toggleMenu()");
    })
    //选择文章种类
    document.getElementById("articleSelect").addEventListener('tap',function(){
    	plus.webview.getWebviewById("discovery").evalJS("toggleMenu()");
    	this.classList.toggle('mui-icon-arrowdown');
		this.classList.toggle('mui-icon-arrowup');
    })
    //选项卡点击事件
    var activeTab = 'home';
    var title=document.querySelector(".mui-title");
	mui('.mui-bar-tab').on('tap', 'a', function(e) {
		//获取目标子页的id
	    var targetTab = this.getAttribute('data-tab');
	    if (targetTab == activeTab) {
	        return;
	    }else if(targetTab == "home"){
	    	//首页显示城市选择按钮
	    	document.getElementById("citySelect").style.display = "block";
	    	document.getElementById("articleSelect").style.display ="none";
	    	//距离上次刷新超过10分钟，重新载入数据
	    	if(new Date().getTime()-plus.storage.getItem('homeUpdateTime')>600000){
	    		plus.webview.getWebviewById('home').evalJS("homeLoad()");
	    	}
	    }else if(targetTab == "discovery"){
	    	document.getElementById("citySelect").style.display = 'none';
	    	document.getElementById("articleSelect").style.display = "";
	    }else{
	    	document.getElementById("citySelect").style.display = "none";
	    	document.getElementById("articleSelect").style.display = "none";
		    if(targetTab == "account"){
		    	app.setUser();
		    	var user = plus.storage.getItem('user');
		    	if(user != null){
					user = JSON.parse(user);
					mui.fire(plus.webview.getWebviewById('account'),'refresh',{user:user});
				}else{
					plus.webview.getWebviewById('account').evalJS("noUser()");
				}
		    }else if(targetTab == "team"){
		    	//距离上次刷新超过10分钟，重新载入数据
		    	if(new Date().getTime()-plus.storage.getItem('teamUpdateTime')>600000){
		    		plus.webview.getWebviewById('team').evalJS("loadTeam()");
		    	}
		    }
	    }
	    
	    //更换标题
	    title.innerHTML = this.querySelector('.mui-tab-label').innerHTML;
	    //显示目标选项卡
    	plus.webview.hide(activeTab);
	    plus.webview.show(targetTab);
	    //隐藏当前选项卡
    	activeTab = targetTab;
	});
	
	//首页返回键处理,处理逻辑：1秒内，连续两次按返回键，则退出应用；
	var backfirst = null;
	mui.back = function() {
		if (!backfirst) {
			backfirst = new Date().getTime();
			mui.toast('再按一次退出应用');
			setTimeout(function() {
				backfirst = null;
			}, 1000);
		} else {
			if (new Date().getTime() - backfirst < 1000) {
				plus.runtime.quit();
			}
		}
	};
});

</script>
<style type="text/css">
.mui-pull-top-pocket{margin-top:30px}
.tab-home .iconfont:before { content: "\e621";}
.tab-home.mui-active .iconfont:before { content: "\e624";}
.tab-team .iconfont:before { content: "\e619";}
.tab-team.mui-active .iconfont:before { content: "\e600";}
.tab-chat .iconfont:before { content: "\e63a"; }
.tab-chat.mui-active .iconfont:before { content: "\e622";}
.tab-account .iconfont:before { content: "\e630";}
.tab-account.mui-active .iconfont:before { content: "\e62f";}
.icon-qipao{position: absolute;top:6px;right:12px;font-size: 12px;color: #2E8B57;display: none;}
</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<a class="mui-pull-left mui-btn-link" id="citySelect" style="color: #333;font-size: 14px;padding-left: 5px;">
			<font></font> 
			<span class="mui-icon mui-icon-arrowdown" style="font-size: 16px;"></span>
		</a>
		<h1 class="mui-title"> 首页 </h1>
		<span class="mui-icon mui-icon-arrowdown" id='articleSelect' style="font-size: 18px;display: none;position: relative;left:55%;top:10%"></span>
		<a class="iconfont icon-bubble mui-icon mui-pull-right" style="color: #0F9D58;font-size: 22px;">
			<span class="iconfont icon-qipao"></span>
		</a>
	</header>
	<nav class="mui-bar mui-bar-tab">
        <a class="mui-tab-item mui-active tab-home" data-tab="home">
            <span class="mui-icon iconfont"></span>
            <span class="mui-tab-label">首页</span>
        </a>
        <a class="mui-tab-item tab-team" data-tab="team">
            <span class="mui-icon iconfont"></span>
            <span class="mui-tab-label">团队</span>
        </a>
        <a class="mui-tab-item tab-chat" data-tab="discovery">
            <span class="mui-icon iconfont"></span>
            <span class="mui-tab-label">发现</span>
        </a>
        <a class="mui-tab-item tab-account" data-tab="account">
            <span class="mui-icon iconfont"></span>
            <span class="mui-tab-label">我的</span>
        </a>
	</nav>
</body>
</html>
